# =============================================================================
# MuleGuard Rules Configuration
# Migration Scope: Mule 4.3.x/4.4.x/4.6.x â†’ 4.9.0 + JDK 17 + Policy Modernization + RTF 4.3
# Total Rules: 24
#Author: Rakesh Kumar (rakesh.kumar@ibm.com, raksjnu@gmail.com)
# =============================================================================

config:
  # Regex pattern to identify configuration projects by folder name
  folderPattern: ".*_config.*"

  # Numeric range for rules that should ONLY apply to configuration projects
  rules:
    start: 100
    end: 199
  
  # Global list of environments to be used by config rules
  environments:
    - "SBX"
    - "ATDV"
    - "TDV1"
    - "TDV"
    - "IBF"
    - "MNE"
    - "MNE1"
    - "MNE2"
    - "ITE"
    - "PITE"
    - "PREP"
    - "DRL"
    - "TRN"
    - "PROD"
    - "DR"

rules:
  - id: "RULE-000"
    name: "Generic Code Check"
    description: "Scans configured files for configured tokens. Fails if tokens are found."
    enabled: true
    severity: "HIGH"
    checks:
      - type: "GENERIC_CODE_TOKEN_CHECK"
        params:
          filePatterns:
            - "src/main/mule/*.xml"
            - "src/main/resources/*.dwl"
          tokens:
            - "seceure:"
  - id: "RULE-001"
    name: "Update pom parent: MuleParentPom version:LATEST"
    description: "Parent pom must be com.raks.eapi:MuleParentPom:LATEST"
    enabled: true
    severity: LOW
    checks:
      - type: POM_PARENT
        params:
          groupId: "com.raks.eapi"
          artifactId: "MuleParentPom"
          versionPattern: "LATEST"

  - id: "RULE-002"
    name: "Update pom property: mule.maven.plugin.version to 4.9.0"
    enabled: true
    severity: LOW
    checks:
      - type: POM_PROPERTY
        params:
          property: "mule.maven.plugin.version"
          expectedValue: "4.9.0"

  - id: "RULE-003"
    name: "Remove pom plugin: maven-clean-plugin"
    enabled: true
    severity: MEDIUM
    checks:
      - type: POM_PLUGIN_REMOVED
        params:
          plugins:
            - "org.apache.maven.plugins:maven-clean-plugin"
            - "org.apache.maven.plugins:maven-surefire-plugin"

  - id: "RULE-004"
    name: "Remove pom dependency: spring-security-ldap, spring-security-web, mule-module-spring-config, and db2jcc_license_cu"
    enabled: true
    severity: MEDIUM
    checks:
      - type: POM_DEPENDENCY_REMOVED
        params:
          dependencies:
            - "org.springframework.security:spring-security-ldap"
            - "org.springframework.security:spring-security-web"
            - "org.mule.modules:mule-module-spring-config"
            - "com.ibm.db2:db2jcc_license_cu"
            - "com.mulesoft.mule.core:mule-core-ee"
            - "com.mulesoft.mule.runtime.modules:mule-module-spring-config-ee"
  - id: "RULE-005" 
    name: "Validate IBM MQ Connector Cipher Suite"
    description: "The IBM MQ connector configuration must use the approved cipher suite."
    enabled: true
    severity: HIGH
    checks:
      - type: IBM_MQ_CIPHER_CHECK
        params:
          xpath: "//ibm-mq:connection/@cipherSuite"
          expectedValue: "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"

  - id: "RULE-006"
    name: "Add pom dependency: apimuleutilities for JCE Encrypt/Decrypt"
    enabled: true
    severity: HIGH
    checks:
      - type: POM_DEPENDENCY_ADDED
        params:
          groupId: "com.raks.eapi"
          artifactId: "apimuleutilities"

  - id: "RULE-007"
    name: "Validate mule-artifact.json (Mule 4.9+, Java 17, secureProperties)"
    description: "Ensures mule-artifact.json meets minimum runtime and security requirements"
    enabled: true
    severity: HIGH
    checks:
      - type: MULE_ARTIFACT_JSON_FULL
        params:
          minVersions:
            minMuleVersion: "4.9.0"           # it can accepts 4.9.0, 4.9.1, 4.10.0, etc.
          requiredStrings:
            javaSpecificationVersions: "17"   # Exact match
          requiredElements:
            - "secureProperties"

  - id: "RULE-008"
    name: "Check for api-gateway:autodiscovery"
    description: "Verifies that the api-gateway:autodiscovery element is present in a Mule configuration file."
    enabled: true
    severity: MEDIUM
    checks:
      - type: XML_XPATH_EXISTS
        params:
          path: "src/main/mule/*.xml"
          xpath: "//*[local-name()='autodiscovery']"
          #xpath: "//*[local-name()='module-loggingconnector:request_in']"
          failureMessage: "API Autodiscovery is not enabled. The <api-gateway:autodiscovery> element is missing."

  - id: "RULE-009"
    name: "Remove unsupported error handling expressions"
    description: "Scans for legacy error expressions like error.errorType, error.muleMessage, etc., which are not supported in modern Mule 4 error handling."
    enabled: true
    severity: HIGH
    checks:
      - type: UNSUPPORTED_ERROR_EXPRESSIONS
        params:
          unsupportedTokens:
            - "error.errorType"
            - "error.muleMessage"
            - "error.exception"
            - "error.errors"

  - id: "RULE-010"
    name: "Remove unsupported from/to ApplicationCode attributes"
    description: "Scans for fromApplicationCode or toApplicationCode attributes in logging connector elements."
    enabled: true
    severity: HIGH
    checks:
      - type: UNSUPPORTED_XML_ATTRIBUTE
        params:
          path: "src/main/mule/*.xml"
          elements:
            - "request_in"
            - "request_out"
            - "response_in"
            - "response_out"
          attributes:
            - "fromApplicationCode"
            - "toApplicationCode"

  - id: "RULE-011"
    name: "Check for DLP references"
    description: "Scans for specific DLP-related property references in configuration and property files."
    enabled: true
    severity: HIGH
    checks:
      - type: DLP_REFERENCE_CHECK
        params:
          files:
            - "mule/http-proxy.xml"
            - "resources/*.properties"
          tokens:
            - "north.bound.dlp.flag"
            - "south.bound.dlp.flag"
            - "wmq.dlp.requestqueue"

  - id: "RULE-012"
    name: "Check for legacy JCE PBE encryption algorithm"
    description: "Scans for the usage of PBEWithHmacSHA256AndAES_256 in crypto:jce-encrypt-pbe elements."
    enabled: true
    severity: HIGH
    checks:
      - type: CRYPTO_JCE_ENCRYPT_PBE_CHECK
        params:
          path: "src/main/mule/*.xml"
          elementName: "crypto:jce-encrypt-pbe"
          forbiddenValue: "PBEWithHmacSHA256AndAES_256"

  - id: "RULE-013"
    name: "Check for 'type' attribute in crypto:jce-config"
    description: "Ensures that any crypto:jce-config element has the 'type' attribute defined."
    enabled: true
    severity: HIGH
    checks:
      - type: CRYPTO_JCE_CONFIG_TYPE_CHECK
        params:
          path: "src/main/mule/*.xml"
          elementName: "crypto:jce-config"
          requiredAttribute: "type"

  - id: "RULE-014"
    name: "Check for toBase64 in set-variable"
    description: "Scans for the use of the 'toBase64' token within a 'set-variable' element."
    enabled: true
    severity: HIGH
    checks:
      - type: FORBIDDEN_TOKEN_IN_ELEMENT
        params:
          elementName: "set-variable"
          forbiddenToken: "toBase64"

  # =============================================================================
  # Configuration Rules (100-199)
  # =============================================================================
  - id: "RULE-100"
    name: "Generic Config Check"
    description: "Scans configured files for configured tokens. Fails if tokens are not found."
    enabled: true
    severity: "HIGH"
    checks:
      - type: "SUBSTRING_TOKEN_CHECK"
        params:
          filePatterns:
            - "**/Properties/**/*.properties"
          tokens:
            - "apiidi"
  - id: "RULE-101"
    name: "Check for environment config property"
    description: "Ensures that all environment property files contain the required config property."
    enabled: true
    severity: HIGH
    checks:
      - type: CONFIG_PROPERTY_EXISTS
        params:
          propertyNames:
            - "LogJsonFormat"
            - "anotherpropertycheck"
            # We can add more properties to check here, for example:
            # - "another.required.property"
          fileExtensions: 
            - ".properties"

  - id: "RULE-102"
    name: "Check for required policy properties"
    description: "Ensures that all environment policy files contain the required policy properties."
    enabled: true
    severity: HIGH
    checks:
      - type: CONFIG_POLICY_EXISTS
        params:
          propertyNames:
            - "rakspolicyproperty"
            - "rakspolicyproperty2.policypropname"
          fileExtensions: 
            - ".policy"