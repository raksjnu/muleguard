# =============================================================================
# MuleGuard Rules Configuration
# Migration Scope: Mule 4.3.x/4.4.x/4.6.x â†’ 4.9.0 + JDK 17 + Policy Modernization + RTF 4.3
# Total Checklist: more than 25
#Author: Rakesh Kumar (rakesh.kumar@ibm.com, raksjnu@gmail.com)
# =============================================================================

config:
  # Regex pattern to identify configuration projects by folder name
  folderPattern: ".*_config.*"

  # Numeric range for rules that should ONLY apply to configuration projects
  rules:
    start: 100
    end: 199
  
  # Global list of environments to be used by config rules
  environments:
    - "SBX"
    - "ATDV"
    - "TDV1"
    - "TDV"
    - "IBF"
    - "MNE"
    - "MNE1"
    - "MNE2"
    - "ITE"
    - "PITE"
    - "PREP"
    - "DRL"
    - "TRN"
    - "PROD"
    - "DR"

rules:
  - id: "RULE-000"
    name: "Generic Code Check"
    description: "Scans configured files for configured tokens. Fails if tokens are found."
    enabled: true
    severity: "HIGH"
    checks:
      - type: "GENERIC_CODE_TOKEN_CHECK"
        params:
          filePatterns:
            - "src/main/mule/*.xml"
            - "src/main/resources/*.dwl"
          tokens:
            - "DONT_USE"
  - id: "RULE-001"
    name: "Update pom parent: MuleParentPom version:LATEST"
    description: "Parent pom must be com.raks.eapi:MuleParentPom:LATEST"
    enabled: true
    severity: LOW
    checks:
      - type: POM_PARENT
        params:
          groupId: "com.raks.eapi"
          artifactId: "MuleParentPom"
          versionPattern: "LATEST"

  - id: "RULE-002"
    name: "Update pom property: mule.maven.plugin.version to 4.9.0"
    enabled: true
    severity: LOW
    checks:
      - type: POM_PROPERTY
        params:
          property: "mule.maven.plugin.version"
          expectedValue: "4.9.0"

  - id: "RULE-003"
    name: "Remove pom plugin: maven-clean-plugin"
    enabled: true
    severity: MEDIUM
    checks:
      - type: POM_PLUGIN_REMOVED
        params:
          validationType: PLUGIN_NOT_EXISTS
          plugins:
            - "org.apache.maven.plugins:maven-clean-plugin"
            - "org.apache.maven.plugins:maven-surefire-plugin"

  - id: "RULE-004"
    name: "Remove pom dependency: spring-security-ldap, spring-security-web, mule-module-spring-config, and db2jcc_license_cu"
    enabled: true
    severity: MEDIUM
    checks:
      - type: POM_DEPENDENCY_REMOVED
        params:
          validationType: DEPENDENCY_NOT_EXISTS
          dependencies:
            - groupId: "org.springframework.security"
              artifactId: "spring-security-ldap"
            - groupId: "org.springframework.security"
              artifactId: "spring-security-web"
            - groupId: "org.mule.modules"
              artifactId: "mule-module-spring-config"
            - groupId: "com.ibm.db2"
              artifactId: "db2jcc_license_cu"
            - groupId: "com.mulesoft.mule.core"
              artifactId: "mule-core-ee"
            - groupId: "com.mulesoft.mule.runtime.modules"
              artifactId: "mule-module-spring-config-ee"
  - id: "RULE-005" 
    name: "Validate IBM MQ Connector Cipher Suite"
    description: "The IBM MQ connector configuration must use the approved cipher suite."
    enabled: true
    severity: HIGH
    checks:
      - type: IBM_MQ_CIPHER_CHECK
        params:
          validationType: ATTRIBUTE_VALUE
          xpath: "//*[local-name()='connection']/@cipherSuite"
          expectedValue: "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
          propertyResolution: true

  - id: "RULE-006"
    name: "Add pom dependency: apimuleutilities for JCE Encrypt/Decrypt"
    enabled: true
    severity: HIGH
    checks:
      - type: POM_DEPENDENCY_ADDED
        params:
          validationType: DEPENDENCY_EXISTS
          dependencies:
            - groupId: "com.raks.eapi"
              artifactId: "apimuleutilities"

  - id: "RULE-007"
    name: "Validate mule-artifact.json (Mule 4.9+, Java 17, secureProperties)"
    description: "Ensures mule-artifact.json meets minimum runtime and security requirements"
    enabled: true
    severity: HIGH
    checks:
      - type: MULE_ARTIFACT_JSON_FULL
        params:
          minVersions:
            minMuleVersion: "4.9.0"           # it can accepts 4.9.0, 4.9.1, 4.10.0, etc.
          requiredStrings:
            javaSpecificationVersions: "17"   # Exact match
          requiredElements:
            - "secureProperties"

  - id: "RULE-008"
    name: "Check for api-gateway:autodiscovery"
    description: "Verifies that the api-gateway:autodiscovery element is present in a Mule configuration file."
    enabled: true
    severity: MEDIUM
    checks:
      - type: XML_XPATH_EXISTS
        params:
          validationType: EXISTS
          path: "src/main/mule/*.xml"
          xpath: "//*[local-name()='autodiscovery']"
          #xpath: "//*[local-name()='module-loggingconnector:request_in']"
          failureMessage: "API Autodiscovery is not enabled. The <api-gateway:autodiscovery> element is missing."

  - id: "RULE-009"
    name: "Remove unsupported error handling expressions"
    description: "Scans for legacy error expressions like error.errorType, error.muleMessage, etc., which are not supported in modern Mule 4 error handling."
    enabled: true
    severity: HIGH
    checks:
      - type: UNSUPPORTED_ERROR_EXPRESSIONS
        params:
          unsupportedTokens:
            - "error.errorType"
            - "error.muleMessage"
            - "error.exception"
            - "error.errors"

  - id: "RULE-010"
    name: "Remove unsupported from/to ApplicationCode attributes"
    description: "Scans for fromApplicationCode or toApplicationCode attributes in logging connector elements."
    enabled: true
    severity: HIGH
    checks:
      - type: UNSUPPORTED_XML_ATTRIBUTE
        params:
          validationType: FORBIDDEN_ATTRIBUTE
          path: "src/main/mule/*.xml"
          elements:
            - "request_in"
            - "request_out"
            - "response_in"
            - "response_out"
            - "ee:transform"
            
          attributes:
            - "fromApplicationCode"
            - "toApplicationCode"
            - "doc:id"

  # RULE-011: Token search in specific files - REUSABLE!
  - id: "RULE-011"
    name: "Check for DLP references"
    description: "Scans for specific DLP-related property references in configuration and property files."
    enabled: true
    severity: HIGH
    checks:
      - type: DLP_REFERENCE_CHECK
        params:
          # Add more file patterns if needed
          filePatterns:
            - "mule/http-proxy.xml"
            - "resources/*.properties"
          # Add more tokens to search for
          tokens:
            - "north.bound.dlp.flag"
            - "south.bound.dlp.flag"
            - "wmq.dlp.requestqueue"
          searchMode: FORBIDDEN
          matchMode: SUBSTRING

  - id: "RULE-012"
    name: "Check for legacy JCE PBE encryption algorithm"
    description: "Scans for the usage of PBEWithHmacSHA256AndAES_256 in crypto:jce-encrypt-pbe elements."
    enabled: true
    severity: HIGH
    checks:
      - type: CRYPTO_JCE_ENCRYPT_PBE_CHECK
        params:
          validationType: FORBIDDEN_VALUE
          path: "src/main/mule/*.xml"
          elementName: "crypto:jce-encrypt-pbe"
          forbiddenValue: "PBEWithHmacSHA256AndAES_256"

  - id: "RULE-013"
    name: "Check for 'type' attribute in crypto:jce-config"
    description: "Ensures that any crypto:jce-config element has the 'type' attribute defined."
    enabled: true
    severity: HIGH
    checks:
      - type: CRYPTO_JCE_CONFIG_TYPE_CHECK
        params:
          validationType: ATTRIBUTE_EXISTS
          path: "src/main/mule/*.xml"
          elementName: "crypto:jce-config"
          requiredAttribute: "type"

  - id: "RULE-014"
    name: "Check for toBase64 in set-variable"
    description: "Scans for the use of the 'toBase64' token within a 'set-variable' element."
    enabled: true
    severity: HIGH
    checks:
      - type: FORBIDDEN_TOKEN_IN_ELEMENT
        params:
          filePatterns: ["src/main/mule/*.xml"]
          tokens: ["toBase64"]
          elementName: "set-variable"
          searchMode: FORBIDDEN
          matchMode: ELEMENT_ATTRIBUTE

  # =============================================================================
  # Configuration Rules (100-199)
  # =============================================================================
  
  # RULE-100: Mandatory Substring Check for .properties files
  - id: "RULE-100"
    name: "Mandatory substring check for .properties files"
    description: "Scans .properties files for required tokens (exact substring match)"
    enabled: true
    severity: HIGH
    checks:
      - type: MANDATORY_SUBSTRING_CHECK
        params:
          fileExtensions: [".properties"]
          caseSensitive: true  # Exact case-sensitive substring match
          environments: ["ALL"]  # Check all environments
          tokens:
            - "apiId"
  
  # RULE-101: Mandatory Name-Value Check for .properties files
  - id: "RULE-101"
    name: "Mandatory name-value check for .properties files"
    description: "Ensures required properties exist with correct values in .properties files"
    enabled: true
    severity: HIGH
    checks:
      - type: MANDATORY_PROPERTY_VALUE_CHECK
        params:
          fileExtensions: [".properties"]
          delimiter: "="
          caseSensitiveNames: true   # Property names are case-sensitive
          caseSensitiveValues: true  # Property values are case-sensitive
          environments: ["ALL"]  # Check all environments
          properties:
            - name: "LogJsonFormat"
              values: ["true","false"]
            - name: "anotherpropertycheck"
              values: ["somevalue"]

  # RULE-102: Mandatory Substring Check for .policy files
  - id: "RULE-102"
    name: "Mandatory substring check for .policy files"
    description: "Scans .policy files for required tokens (exact substring match)"
    enabled: true
    severity: HIGH
    checks:
      - type: MANDATORY_SUBSTRING_CHECK
        params:
          fileExtensions: [".policy"]
          caseSensitive: true
          environments: ["ALL"]  # Check all environments
          tokens:
            - "http.protocols=HTTPS"
            - "http.private.port=8081"

  # RULE-103: Mandatory Name-Value Check for .policy files
  - id: "RULE-103"
    name: "Mandatory name-value check for .policy files"
    description: "Ensures required policy properties exist with correct values"
    enabled: true
    severity: HIGH
    checks:
      - type: MANDATORY_PROPERTY_VALUE_CHECK
        params:
          fileExtensions: [".policy"]
          delimiter: "="
          caseSensitiveNames: true
          caseSensitiveValues: true
          environments: ["ALL"]  # Check all environments
          properties:
            # Header Injection Policy
            - name: "headerinjection.policy.applied"
              values: ["true"]
            - name: "headerinjection.policy.version"
              values: ["1.3.2", "1.3.3"]  # Allow multiple versions
            
            # Rate Limit Policy
            - name: "ratelimit.policy.applied"
              values: ["true"]
            - name: "ratelimit.policy.version"
              values: ["1.4.2"]
            
            # Composite Authentication Policy
            - name: "truist.compositeauthn.policy.applied"
              values: ["true"]
            - name: "truist.compositeauthn.policy.version"
              values: ["3.0.0"]
            
            # Authorization Policy
            - name: "truist.authz.policy.applied"
              values: ["true"]
            - name: "truist.authz.policy.version"
              values: ["3.0.0"]

            # Asset Type
            - name: "assetType"
              values: ["rest","soap","batch"]

  # RULE-104: Custom Validator for Properties Files
  - id: "RULE-104"
    name: "Validate properties files for correct property details"
    description: "Validates that .properties files contain required configuration properties using custom validators"
    enabled: true
    severity: MEDIUM
    checks:
      # Secure encrypted properties - using custom validator
      - type: CLIENTIDMAP_VALIDATOR
        description: "Validate secure encrypted properties"
        params:
          validationType: "SECURE"
          fileExtensions: [".properties"]
          environments: ["ALL"]  # Support environment selection
      
      # Client ID mapping validation - using custom validator with strict format checking
      - type: CLIENTIDMAP_VALIDATOR
        description: "Validate authorization policy client ID mappings"
        params:
          validationType: "CLIENTIDMAP"
          fileExtensions: [".policy"]
          environments: ["ALL"]  # Support environment selection

  # RULE-105: Optional Name-Value Check for .properties files
  - id: "RULE-105"
    name: "Optional name-value check for .properties files"
    description: "If property exists in .properties files, validates its value"
    enabled: true
    severity: HIGH
    checks:
      - type: OPTIONAL_PROPERTY_VALUE_CHECK
        params:
          fileExtensions: [".properties"]
          delimiter: "="
          caseSensitiveNames: true
          caseSensitiveValues: false  # Example: case-insensitive values
          environments: ["ALL"]
          properties:
            - name: "platform.config.analytics.enabled"
              values: ["true", "false"]
            - name: "requestPathEncryption"
              values: ["Y", "N"]

  # RULE-106: Optional Name-Value Check for .policy files
  - id: "RULE-106"
    name: "Optional name-value check for .policy files"
    description: "If property exists in .policy files, validates its value"
    enabled: true
    severity: HIGH
    checks:
      - type: OPTIONAL_PROPERTY_VALUE_CHECK
        params:
          fileExtensions: [".policy"]
          delimiter: "="
          caseSensitiveNames: true
          caseSensitiveValues: true
          environments: ["ALL"]
          properties:
            - name: "mTLS-AuthZ.policy.version"
              values: ["3.0.0", "3.0.1"]
            - name: "wssencdec.policy.version"
              values: ["3.0.0", "3.0.1"]